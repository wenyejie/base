<!doctype html>
<!--
 - @author: Storm
 - @date: 2019-03-07
 - @email: wenyejie@foxmail.com
 -->
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <title>Mvvm</title>
</head>
<body>
  <div id="app">
    <input v-model="message">
    <div>{{ message }}</div>
  </div>
  <script>
  const regexp = /{{(?<key>[^}]+)}}/g

  function compile (vm, $el) {
    // const group = $el.innerHTML.match(regexp)
    console.log({ $el })
    const compileAttrs = (node) => {
      const attrs = node.attributes
      const length = attrs.length
      for (let i = 0; i < length; i++) {
        const attr = attrs[0]
        const name = attr.name
        const value = attr.value
        switch (name) {
          case 'v-model':
            node.value = vm[value]
            node.addEventListener('input', event => {
              vm[name] = event.target.value
            })
            break
        }
        node.removeAttribute(name)
      }
    }
    const compileNodes = (node) => {
      switch (node.nodeType) {
        case 1: // element
          compileAttrs(node)
          loop(node)
          break
        case 3:
          break
      }
    }

    const loop = (nodes) => {
      nodes.childNodes.forEach(node => compileNodes(node))
    }

    loop($el)
  }

  class Watcher {
    constructor () {
      this.callbackQueue = []
    }

    update ({vm, node, value}) {
      console.log('watcher.update', vm, node, value)
    }

    add (vm, node, value) {
      this.callbackQueue.push({ vm, node, value })
    }

    notify () {
      console.log('watcher =>', this)
      this.callbackQueue.forEach(params => this.update(params))
    }
  }

  function observe (vm, data) {
    const proxy = new Proxy(vm, {
      get (obj, key) {
        console.log('get', key, data[key])
        return data[key]
      },
      set (obj, key, val) {
        console.log('set', obj, key, val)
        vm.$watcher[key].notify()
        return val
      }
    })
    for (let key in data) {
      if (data.hasOwnProperty(key)) {
        vm[key] = data[key]
        vm.$watcher[key] = new Watcher()
      }
    }
    return proxy
  }

  class Mvvm {
    constructor (options = {}) {
      this.$el = document.querySelector(options.el)
      let data
      if (typeof options.data === 'function') {
        data = options.data()
      } else if (typeof options.data === 'object') {
        data = options.data
      }
      this.$watcher = {}
      const proxy = observe(this, data)
      compile(proxy, this.$el)
      return proxy
    }
  }

  const vm = new Mvvm({
    el: '#app',
    data () {
      return {
        message: 'Hello World!'
      }
    },
    methods: {}
  })
  // console.log(vm)
  </script>
</body>
</html>
