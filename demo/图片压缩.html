<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <title>图片压缩</title>
    <link rel="stylesheet" href="../assets/prism.css" />
  </head>
  <body>
    <input type="file" id="input" accept="image/*" />
    <div>
      结果为:
      <pre id="result"><img id="img" /></pre>
    </div>
    <pre><code
  data-code-highlight="javascript"
  class="language-javascript"></code></pre>
    <script src="../node_modules/wenyejie-utils/dist/index.js"></script>
    <script data-code-highlight="javascript">
      window.s = window.t || window.s
      const $input = document.querySelector('#input')
      const $picture = document.querySelector('#img')
      const file2base64 = (file) => {
        return new Promise((resolve) => {
          const reader = new FileReader()
          reader.readAsDataURL(file)
          reader.onload = () => resolve(reader.result)
        })
      }

      const file2url = (file) => {
        return Promise.resolve(window.URL.createObjectURL(file))
      }

      const createImgByUrl = (url) => {
        return new Promise((resolve) => {
          const img = document.createElement('img')
          img.src = url
          img.onload = () => resolve(img)
        })
      }
      const file2img = async (file) => {
        const base64 = await file2url(file)
        return await createImgByUrl(base64)
      }

      const createCanvas = ($img, options) => {
        return new Promise((resolve) => {
          const $canvas = document.createElement('canvas')
          const context = $canvas.getContext('2d')
          context.fillStyle = options.fillStyle
          context.fillRect(0, 0, $canvas.width, $canvas.height)
          resolve({ context, $canvas })
        })
      }
      const calcDrawSize = ($img, options) => {
        const proportion = $img.naturalWidth / $img.naturalHeight
        let dw
        let dh
        if (proportion >= 1) {
          if (options.maxWidth > 0) {
            dw = $img.naturalWidth > options.maxWidth ? options.maxWidth : $img.naturalWidth
          } else {
            dw = $img.naturalWidth
          }
          dh = dw / proportion
        } else {
          if (options.maxHeight > 0) {
            dh = $img.naturalHeight > options.maxHeight ? options.maxHeight : $img.naturalHeight
          } else {
            dh = $img.naturalHeight
          }
          dw = dh * proportion
        }
        return { dw, dh }
      }
      const canvas2file = ($canvas, file, options) => {
        return new Promise((resolve) => {
          const type = options.type ? options.type : file.type
          const fileName = options.fileName
            ? s.prefix(options.fileName) + '.' + type.replace('image/', '')
            : file.name
          $canvas.toBlob(
            (blob) => {
              resolve(new File([blob], fileName, { type }))
            },
            type,
            options.quality
          )
        })
      }
      const defaultOptions = {
        size: 0, // 文件大小
        maxSize: 10 * 1024 * 1024, // 最大不能超过10m
        width: 0, // 固定宽度, 0为不固定
        height: 0, // 固定高度, 0为不固定
        maxWidth: 1024, // 最大宽度, 默认1024
        minWidth: 0, // 最小宽度, 0为不限制
        maxHeight: 1024, // 最大高度, 默认1024
        minHeight: 0, // 最小高度, 0为不限制
        fillStyle: 'rgba(255, 255, 255, 0)', // 填充底色, 默认透明
        quality: 0.75, // 压缩之后的质量, 不压缩为1, 默认0.75
        type: '', // 压缩之后重新保存的格式, 如: image/jpeg, image/png, 不填为图片原有格式
        fileName: '', // 压缩之后的文件名称, 不填则为原有名称
        shear: false // 是否允许裁剪
      }
      const imageCompress = async (file, options = {}) => {
        options = Object.assign({}, defaultOptions, options)
        // const base64 = await file2base64(file)
        // const $img = await createImgByUrl(base64)
        const $img = await file2img(file)
        const { dw, dh } = await calcDrawSize($img, options)
        const { context, $canvas } = await createCanvas($img, options)
        $canvas.width = dw
        $canvas.height = dh
        context.drawImage($img, 0, 0, $img.naturalWidth, $img.naturalHeight, 0, 0, dw, dh)

        const compressFile = await canvas2file($canvas, file, options)
        $picture.src = await file2base64(compressFile)
        console.log(`before: ${file.size}`, `after: ${compressFile.size}`, file, compressFile)

        // 如果压缩之后质量没有减少, 反而变大了, 则返回原图
        if (file.size <= compressFile.size) {
          return file
        }
        return compressFile
      }
      $input.addEventListener('change', (event) => {
        imageCompress(event.target.files[0], { quality: 0.9 })
      })
      // document.querySelector('#result').innerHTML = JSON.stringify()
    </script>
    <script src="../assets/codeHighlight.js"></script>
    <script src="../assets/prism.js"></script>
  </body>
</html>
